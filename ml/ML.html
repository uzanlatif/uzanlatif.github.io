<!DOCTYPE html>
<html>
  <head>
    <title>My ML Web App</title>
    <link rel="stylesheet" href="ml.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
  </head>
  <body>
    <center>
      <div id="myBox" class="text-center">
        <h1 style="font-size: 40px; font-weight: bold;">BODY FAT MEASUREMENT</h1>
        <form id="image-form">
          <img id="selected-image" src="" alt="Selected Image" class="container" style="width: 200px; display:none;">
          <input type="file" id="input-image" accept="image/*,.heic">
          <br>
          <button type="submit" class="btn btn-success">Predict</button>
        </form>
        <div id="output-container" class="mt-3"></div>
      </div>
    </center>

    <script>
      async function loadModel() {
        const outputContainer = document.getElementById('output-container');
        const selectedImageElement = document.getElementById('selected-image');

        const modelUrl = 'theModel/NewModel/model.json';
        const model = await tf.loadLayersModel(modelUrl);

        const inputElement = document.getElementById('input-image');
        const img = new Image();

        img.onload = async () => {
          // Convert the image to grayscale
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 224;
          canvas.height = 224;
          ctx.drawImage(img, 0, 0, 224, 224);
          const imageData = ctx.getImageData(0, 0, 224, 224);
          for (let i = 0; i < imageData.data.length; i += 4) {
            const gray = Math.round(0.299 * imageData.data[i] + 0.587 * imageData.data[i + 1] + 0.114 * imageData.data[i + 2]);
            imageData.data[i] = gray;
            imageData.data[i + 1] = gray;
            imageData.data[i + 2] = gray;
          }
          ctx.putImageData(imageData, 0, 0);

          // Display the selected grayscale image
          selectedImageElement.src = canvas.toDataURL();
          selectedImageElement.style.display = 'block';

          const tensor = tf.browser.fromPixels(canvas).resizeBilinear([224, 224]).expandDims(0);
          const prediction = model.predict(tensor);
          const predictionValue = await prediction.data();

          const classes = ['Athletes', 'Fitness', 'Acceptable', 'Obese'];
          let maxIndex = 0;
          for (let i = 1; i < predictionValue.length; i++) {
            if (predictionValue[i] > predictionValue[maxIndex]) {
              maxIndex = i;
            }
          }

          const confidencePercentage = (predictionValue[maxIndex] * 100).toFixed(2);

          const predictedClass = classes[maxIndex];
          const predictedClassElement = document.createElement('h1');
          predictedClassElement.innerText = `Predicted class: ${predictedClass}`;

          const confidenceElement = document.createElement('h2');
          confidenceElement.innerText = `Confidence: ${confidencePercentage}%`;

          outputContainer.innerHTML = '';
          outputContainer.appendChild(predictedClassElement);
          outputContainer.appendChild(confidenceElement);
        };

        img.src = URL.createObjectURL(inputElement.files[0]);
      }

      const formElement = document.getElementById('image-form');
      formElement.addEventListener('submit', (event) => {
        event.preventDefault();
        loadModel();
      });
    </script>
  </body>
</html>
